# ARBEL(beta) 
This repository contains tools for the beta version  of ARBEL (Automated Recognition of Behavioral Enhanced with Light). 

## **License**
[![License: CC BY-NC-ND 4.0](https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

This project is licensed under the Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License (CC BY-NC-ND 4.0).



## **Citation**
ARBEL: A Machine Learning Tool with Light-Based Image Analysis for Automatic Classification of 3D Pain Behaviors.
Omer Barkai, Biyao Zhang,  Bruna Lenfers Turnes, Maryam Arab,  David A Yarmolinsky, Zihe Zhang, Lee B Barrett,  Clifford J Woolf  
[bioRxiv preprint] - doi: https://doi.org/10.1101/2024.12.01.625907  

Please cite our work and follow our publication updates.


---
## **ARBEL_TrainClassifier.py**
This script trains a machine learning classifier to recognize specific behaviors in animals based on features extracted from pose estimation and video data. 

### Key Features:
- Prepares a feature matrix from pose-estimation data (DeepLabCut output) and corresponding videos.
- Integrates behavioral target labels (e.g., manually annotated behavior events) from `.csv` files.
- Trains a classification model using features and target labels.
- Saves the trained classifier model for later use in behavior prediction.
- Saves the model's performance metrics on the test set.
- Saves the feature importance explenation analysis (SHAP) figure.
Optional:
- Saves the learning curve 

### Input Requirements:
1. **Pose Estimation Data**: DLC `.h5` (or `.csv`) files should be in the `project/Videos` folder, alongside their corresponding video files.
2. **Video Files**: Should also reside in the `project/Videos` folder.
3. **Target Files**: Behavior labels in `.csv` format should be placed in the `project/Targets` folder.

---

## **ARBEL_AutoScore.py**
This script uses a trained classifier to automatically score behaviors in videos. It predicts behavior bouts and refines them with post-processing filters.

### Key Features:
- Loads a pre-trained ARBEL classifier model.
- Extracts features from pose estimation and video data using the same pipeline as in the training process.
- Predicts behaviors for each video based on the extracted features.
- Applies post-processing to refine predictions (e.g., removing spurious short bouts, filling small gaps).
- Generates output files with predicted behavior bouts.
Optional:
- Generates a video with frame-by-frame behavior bout labeling, indicating when a specific behavior occurs. 

### Input Requirements:
1. **Video Files**: Should reside in the `project/Videos` folder.
2. **Pose Estimation Data**: DLC `.h5` (or `.csv`) files should be in the `project/Videos` folder, alongside their corresponding video files. DLC pose-estimation can be also done as part of the pipeline. 
3. **Trained Classifier Model**: A model generated by `ARBEL_TrainClassifier.py`.

### Output:
- Predicted behavior bouts for each video are saved in the output folder.
- (Optional) Labeled behavior video is saved in the output folder.

---

## **Dependencies**
This project requires the following libraries and tools to run successfully:

### **Python Libraries**
**Data Manipulation**
   - `pandas`: Data analysis and manipulation.
   - `numpy`: Numerical computing.

**Machine Learning**
   - `xgboost`: Gradient boosting framework for classification and regression tasks.
   - `sklearn` (scikit-learn): Tools for model evaluation, including:
     - `f1_score`, `precision_score`, `accuracy_score`, `recall_score`, `r2_score`
     - `confusion_matrix`, `ConfusionMatrixDisplay`
   - `shap`: SHAP (SHapley Additive exPlanations) for model explainability.

**Computer Vision**
   - `cv2` (OpenCV): For video and image processing.

**Pose-estimation (Optional)**
   - `deeplabcut` (DeepLabCut): For animal video pose-estimation.

**Visualization**
   - `matplotlib`: For plotting and graphical visualization.
     - Requires a compatible backend (`Qt5Agg`) for interactive plotting.

**Core Libraries**
   - `os`: For file and directory operations.
   - `time`: For time-related operations.
   - `gc`: For garbage collection.
   - `random`: For random number generation.
   - `datetime`: For date and time management.
   - `glob`: For pattern matching file operations.

### **System Requirements**
- **Operating System**: Linux or Windows recommended (with compatible Python environment).
- **Video Backend**: Ensure OpenCV is installed and configured properly for video handling.
- GPU recommended. 
